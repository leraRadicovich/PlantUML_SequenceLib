@startuml
/'Процедура инициации режима работы библиотеки'/
!unquoted procedure diagramInit($mode, $name="", $by="")
    %invoke_procedure("styleController")
    %invoke_procedure("setDiagramTitle", $mode, $name)
    %invoke_procedure("setDiagramHeader",$by)
!endprocedure

/'Установка заголовка диаграммы'/
!unquoted procedure setDiagramTitle($mode, $name="")
    /'Выбор режима работы библиотеки'/
    !$diagramMode = $mode
    !$on = ""
    !if $diagramMode != "final"
        !$on = "\nРежим: <color:blue>draft</color>; Генерация кода в оригинальном синтаксисе: <color:blue>**выключена**"
    !endif

    !if $name == ""
        !$name = %filename()
    !endif
title Диаграмма: <color:blue>$name $on
!endprocedure

/'Установка автора диаграммы'/
!unquoted procedure setDiagramHeader($by)
!global $originalBy = ""
!if $by != ""
    !$originalBy = "\n<color:black>Author: <color:blue>" + $by
!elseif %variable_exists("$author")
    !$originalBy = "\n<color:black>Author: <color:blue>" + $author
!endif
    header <color:black>with <color:blue>SequenceLib.v.4.0.<color:black> by PVR $originalBy
!endprocedure

/'Интерфейс для активации линии жизни'/
!unquoted procedure ACTIVATE($value="")
    !$commonType = "activate"
    %invoke_procedure("activationDeactivationController", $value,$commonType)
!endprocedure

/'Интерфейс для деактивации линии жизни'/
!unquoted procedure DEACTIVATE($value="")
    !$commonType = "deactivate"
    %invoke_procedure("activationDeactivationController", $value,$commonType)
!endprocedure

/'Процедура контроллер активации/деактивации линии жизни'/
!unquoted procedure activationDeactivationController($value="",$commonType)
    !$partiesList = ""
    !$partiesList = %splitstr($value, ",")
!foreach $party in $partiesList
!if %not(%json_key_exists($currentAliasMap, $party))
%invoke_procedure("checkParties", $party)
%invoke_procedure("commonBuilder", $commonType, $party)
%invoke_procedure("setOriginalSyntaxCommon", $commonType, $party)
!endif
!endfor
!endprocedure

/'Процедура, создающая и запоминающая идентификатор - якорь'/
!unquoted procedure anchor($name)
    %set_variable_value($name,$id)
!end procedure

/'Процедура разделитель'/
!unquoted procedure SEPARATOR($value="")
    !$commonType = "separator"
    %invoke_procedure("commonBuilder", $commonType, $value)
    %invoke_procedure("setOriginalSyntaxCommon", $commonType, $value)
!endprocedure

/'Процедура добавляет на диаграмму параметры стиля'/
!unquoted procedure styleController()
    !foreach $item in $style
$item
    !endfor
!endprocedure

!$link = "**<size:17><color:blue><&link-intact></color>**"
!$success = "**<size:20><color:green><&circle-check></color>**"
!$error = "**<size:20><color:red><&circle-x></color>**"
!$end = "**<size:20><color:red><&x></color>**"

!unquoted procedure commonBuilder($commonType, $value)
!if $commonType == "activate"
activate $value
!endif
!if $commonType == "deactivate"
deactivate $value
!endif
!if $commonType == "separator"
== $value ==
!endif
!endprocedure

/'Сохранение для генерации диаграммы в оригинальном синтаксисе'/
!unquoted procedure setOriginalSyntaxCommon($type, $value)
    !if $diagramMode == "final"
    !$temp = {}
    !$temp = %json_add($temp, "type", $type)
    !$temp = %json_add($temp, "value", $value)
    !$temp = %json_add($temp, "layerId", $layerId)
    !$originalSyntaxMap = %json_add($originalSyntaxMap, $temp)
    !$techId = $techId + 1
    !endif
!endprocedure