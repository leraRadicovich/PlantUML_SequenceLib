@startuml
/'TODO Додумать вывод в диаграмму с оригинальным синтаксисом'/
/'Вспомогательная процедура отрисовки участников: формирует мапу имя:алиас'/

!unquoted procedure parties($partyType, $name="", $alias="", $order="")
%invoke_procedure("checkPartyInput", $partyType, $name, $alias, $order)
!endprocedure

!unquoted procedure checkPartyInput($partyType, $name="", $alias="", $order="")
    /'Вместо дефолтного типа участников можно передать несколько алиасов'/
    !if %not(%json_key_exists($defaultPartyTypes, $partyType))
        !$alias = $partyType
        !$partyType = ""
        !$name = ""
        !$order = ""

    /'Если не передан дефолтный тип участника, можно указать только 1 алиас'/
    !elseif %size(%splitstr($alias, ",")) > 1
        %invoke_procedure("serviceError", parties, "добавление участника\nс более чем одним алиасом", $alias)
    !endif

    /'Переходим к подготовке объекта для добавления в диаграмму'/
    %invoke_procedure("buildAliasToAdd", $partyType, $name, $alias, $order)
!endprocedure

!unquoted procedure buildAliasToAdd($type="", $name="", $alias="", $order="")
    !$alias = %splitstr($alias, ",")
    !$defaultAttr = ["alias", "type", "name", "order"]
    !foreach $item in $alias
        !$partyAttributes = {}
        /'Формируем объект для добавления в текущий список участников'/
        !foreach $attr in $defaultAttr
            !$value = %get_variable_value("$"+$attr)
            !if $attr == "alias"
                !$value = $item
            !endif
            !$partyAttributes = %json_add($partyAttributes, $attr, $value)
        !endfor
        %invoke_procedure("checkAliasAttributes", $item, $partyAttributes)
    !endfor
!endprocedure

!unquoted procedure checkAliasAttributes($alias, $partyAttributes)
        /'Проверка orderId'/
        !if $partyAttributes.order == ""
            /'TODO продумать, точно ли здесь нужно orderId считать, что в боксах будет'/
            !$orderId = $orderId + 1
            !$partyAttributes = %json_set($partyAttributes, order, $orderId)
        !endif

        /'Если alias найден в текущей диаграмме $currentAliasMap'/
        !if %json_key_exists($currentAliasMap, $alias)
            %invoke_procedure("serviceError", parties, "добавление участника\nс уже используемым алиасом", $alias)
        !endif

        !foreach $field in ["type", "name"]
            !$value = ""
            !if %json_key_exists($customAliasMap, $alias)
                /'Если alias найден в пользовательских настройках'/
                !if $partyAttributes[$field] == ""
                    !$value = $customAliasMap[$alias][$field]
                /'Если alias найден в пользовательских настройках, но объявлен, как новый участник'/
                !elseif $partyAttributes[$field] != "" /'&& $partyAttributes[$field] != $customAliasMap[$alias][$field]'/
                    %invoke_procedure("todo","Проверьте customAliasMap, возможно стоит актуализировать пользовательские настройки.")
                !endif
            !else
                /'Если alias нигде не найден - новый участник'/
                !$functionName = "get" + %call_user_func("getNameByAlias", $field) + "ByAlias"
                !if $partyAttributes[$field] == ""
                    !$value = %call_user_func($functionName, $alias)
                !endif
                %invoke_procedure("todo","Добавьте в customAliasMap нового участника $alias:$partyAttributes")
            !endif

            !if $value != ""
                !$partyAttributes = %json_set($partyAttributes, $field, $value)
            !endif
        !endfor

        !$currentAliasMap = %json_add($currentAliasMap, $alias, $partyAttributes)
        %invoke_procedure("outputAliasController", $alias)
!endprocedure

!unquoted function getNameByAlias($var)
    !$nameByAlias = %upper(%substr($var,0,1)) + %substr($var,1)
    !return $nameByAlias
!end function

!unquoted function getTypeByAlias($var)
    !$typeByAlias = "participant"
    !foreach $item in %get_json_keys($partyTypesDictionary)
        !if %strpos($var, $item) >= 0
            !$typeByAlias = $partyTypesDictionary[$item]
            !break
        !endif
    !endfor
    !return $typeByAlias
!end function


!unquoted procedure outputAliasController($alias)
$currentAliasMap[$alias].type "$currentAliasMap[$alias].name" as $currentAliasMap[$alias].alias order $currentAliasMap[$alias].order
!endprocedure

/' Интерфейсная процедура '/
!unquoted procedure BOX($name, $color="", $parties="")
    %invoke_procedure("boxController", $name, $color, $parties)
!endprocedure

/' Контроллер - логика обработки '/
!unquoted procedure boxController($name, $color="", $parties)
    /' Сначала выводим открытие box '/
    !if $color != ""
        !$color = colorController($color)
    !endif
    box $name $color
    /' Если есть участники - обрабатываем их '/
    !if $parties != ""
        /' Проверяем каждый алиас '/
        !$partyAliases = %splitstr($parties, ",")
        !foreach $alias in $partyAliases
            !if %json_key_exists($currentAliasMap, $alias)
                /' Алиас существует - перемещаем в конец списка '/
                !$partyData = $currentAliasMap[$alias]
                !$currentAliasMap = %json_remove($currentAliasMap, $alias)
                !$currentAliasMap = %json_add($currentAliasMap, $alias, $partyData)
                %invoke_procedure("outputAliasController", $alias)
            !else
                /' Алиас не существует - создаем через parties() '/
                %invoke_procedure("parties", $alias)
            !endif
        !endfor
    end box
    !endif
!endprocedure




