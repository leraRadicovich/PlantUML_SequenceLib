@startuml
/'Цель этой диаграммы: показать зависимость разработчика от требований и разработку требований от разработчика.
Текущая итерация работает, но все ли она покрывает?
если придет имя, которого нет в базе
если придем сумма, больше чем остаток по счтеу (обработка ошибок)
если будет много счетов
если появятся новые операции - например попросить в долг
если появятся отложенные операции (ассинхрон)
если у нас есть прямй досутп к бд, как защитить? возьму и поставлю себе 10000000
'/


title Постановка и реализация в коде на примере оплаты

== Реализация в постановке ==
skinparam maxmessageSize 150

actor "Alice" as a
participant "PaymentService" as srv
database "BackOffice" as bo
actor "Bob" as b

a ->o srv++: Перевести деньги Бобу

srv -> bo++: Запросить отстатки на счете Alice и Bob
bo --> srv--: Остатки по счетам

srv -> srv: Проверить остатки

break У Алисы не хватает денег на перевод
    srv --> a: Денег не хватает
end

srv -> bo++: Сформировтаь транзакции: пополнить счет Боба, уменьшить счет Алисы
bo --> srv--: Остатки по счетам изменены
srv ->> b: Ваш счет пополнен
srv --> a --: Операция выполнена

== Реализация в коде ==

/'env'/
!$db = {
    "alice" : [1000,0,500],
    "bob" : [50]
}

!$defOperationResult = ["Ошибка","Успех"]

/'operation = {
from
to
amount
}
'/

!unquoted function compare($a, $b)
    /'По дефолту считаем, что $a <= $b'/
    !$i = 0
    !if $a > $b
        !$i = 1
    !endif
    !return $i
!end function

!unquoted function getBalance($client)
    !return %intval($db[$client][0])
!end function

!unquoted procedure changeBalance($client,$operation,$amount)
    !if $operation == 0
        !$newBalance = %call_user_func("getBalance", $client) - $amount
    !else
        !$newBalance = %call_user_func("getBalance", $client) + $amount
    !endif

    !$value = []
    !$value = %json_add($value, $newBalance)
    !$value = %json_merge($value, $db[$client])
    !$db = %json_set($db, $client, $value)
!end procedure

!unquoted procedure operationController($data)
    !$data = %str2json($data)
    !$amount = %intval($data.amount)
    !$from = $data.from
    !$to = $data.to

    !$operationResult = 0

    !if %call_user_func("compare", %call_user_func("getBalance", $from), $amount)
        %invoke_procedure("changeBalance",$from,0,$amount)
        %invoke_procedure("changeBalance",$to,1,$amount)
        /'TODO Написать функцию вывода результата'/
        /'TODO Шаблонизировтаь результат и ошибки'/
        !$operationResult = 1
        note across:**Выполнение программы**\n----\nРезультат операции: $defOperationResult[$operationResult]\nОсуществлен перевод с Вашего счета на счет $to. Ваш баланс: %call_user_func("getBalance", $from)
    !else
        !$newBalanceFrom = $accBalanceFrom
        !$newBalanceTo = $accBalanceTo
        note across:Результат операции: $defOperationResult[$operationResult]\nНедостаточно средств. Ваш баланс: %call_user_func("getBalance", $from)
    !endif
!end procedure

!unquoted procedure main($operation)
    note across:$db
    %invoke_procedure(operationController, $operation)
    note across:$db
!endprocedure

!$tr1 = {
"from" : "alice",
"to" : "bob",
"amount" : 150
}

main($tr1)
@enduml